<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/favicon.png">
    <title>Data charts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  </head>
  <body>
    <div id="navbar"></div>

    <div class="container">
        <div style="padding-top: 12px;">
            <div class="row">
                <div class="col-10">
                    <input type="date" class="form-control" id="graphDataDate" name="date">
                </div>
                <div class="col-2">
                    <button class="btn btn-primary" id="searchByDateButton">Search</button>
                </div>
            </div>
        </div>
        <div style="padding-top: 12px;">
            <button class="btn btn-primary" id="downloadAllButton" onclick="downloadAllCharts()">Download All Charts</button>
            <button type="button" class="button btn btn-success" id="emailAllButton" data-bs-toggle="modal" data-bs-target="#allChartModal">Send all chart to email</button>                              
        </div>
        <div style="padding-top: 12px;">
            <div class="row">
                <div class="col-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Moisture chart</h5>
                            <div class="no-data-message alert alert-warning" role="alert">
                                No data found
                            </div>                            
                            <canvas id="moistureChart"></canvas>
                            <button class="hide-button btn btn-primary" onclick="downloadChart('moistureChart', 'Moisture Chart.png')">Download as image</button>
                            <button type="button" class="email-button btn btn-success" data-bs-toggle="modal" data-bs-target="#moistureChartModal">Send chart to email</button>                              
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Temperature chart</h5>
                            <div class="no-data-message alert alert-warning" role="alert">
                                No data found
                            </div>                            
                            <canvas id="temperatureChart"></canvas>
                            <button class="hide-button btn btn-primary" onclick="downloadChart('temperatureChart', 'Temperature Chart.png')">Download as image</button>
                            <button type="button" class="email-button btn btn-success" data-bs-toggle="modal" data-bs-target="#temperatureChartModal">Send chart to email</button>
                        </div>
                    </div>
                </div>   
            </div>
        </div>
        <div style="padding-top: 12px;">
            <div class="row"> 
                <div class="col-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">pH chart</h5>
                            <div class="no-data-message alert alert-warning" role="alert">
                                No data found
                            </div>                            
                            <canvas id="pHChart"></canvas>
                            <button class="hide-button btn btn-primary" onclick="downloadChart('pHChart', 'pH Chart.png')">Download as image</button>
                            <button type="button" class="email-button btn btn-success" data-bs-toggle="modal" data-bs-target="#pHChartModal">Send chart to email</button>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Conductivity chart</h5>
                            <div class="no-data-message alert alert-warning" role="alert">
                                No data found
                            </div>                            
                            <canvas id="conductivityChart"></canvas>
                            <button class="hide-button btn btn-primary" onclick="downloadChart('conductivityChart', 'Conductivity Chart.png')">Download as image</button>
                            <button type="button" class="email-button btn btn-success" data-bs-toggle="modal" data-bs-target="#conductivityChartModal">Send chart to email</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="padding-top: 12px; padding-bottom: 12px;">
            <div class="row"> 
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Nutrients chart</h5>
                            <div class="no-data-message alert alert-warning" style="display: none;" role="alert">
                                No data found
                            </div>                              
                            <canvas id="nutrientsChart"></canvas>
                            <button class="hide-button btn btn-primary" onclick="downloadChart('nutrientsChart', 'Nutrients Chart.png')">Download as image</button>
                            <button type="button" class="email-button btn btn-success" data-bs-toggle="modal" data-bs-target="#nutrientsChartModal">Send chart to email</button>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <div class="modal fade" id="moistureChartModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">Send chart to email</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form class="emailChartForm">
                    <div class="modal-body">
                        <label class="form-label">Enter email address:</label>
                        <input type="email" class="form-control emailChartInput" placeholder="example@example.com" required>
                        <input type="hidden" class="chartTypeInput" value="moisture">
                    </div>
                    <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Send Email</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
              </div>
            </div>
        </div>
        
        <div class="modal fade" id="temperatureChartModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">Send chart to email</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form class="emailChartForm">
                    <div class="modal-body">
                        <label class="form-label">Enter email address:</label>
                        <input type="email" class="form-control emailChartInput" placeholder="example@example.com" required>
                        <input type="hidden" class="chartTypeInput" value="temperature">
                    </div>
                    <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Send Email</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
              </div>
            </div>
        </div>
        
        <div class="modal fade" id="pHChartModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">Send chart to email</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form class="emailChartForm">
                    <div class="modal-body">
                        <label class="form-label">Enter email address:</label>
                        <input type="email" class="form-control emailChartInput" placeholder="example@example.com" required>
                        <input type="hidden" class="chartTypeInput" value="pH">
                    </div>
                    <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Send Email</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
              </div>
            </div>
        </div>

        <div class="modal fade" id="conductivityChartModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">Send chart to email</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form class="emailChartForm">
                    <div class="modal-body">
                        <label class="form-label">Enter email address:</label>
                        <input type="email" class="form-control emailChartInput" placeholder="example@example.com" required>
                        <input type="hidden" class="chartTypeInput" value="conductivity">
                    </div>
                    <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Send Email</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
              </div>
            </div>
        </div>

        <div class="modal fade" id="nutrientsChartModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">Send chart to email</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form class="emailChartForm">
                    <div class="modal-body">
                        <label class="form-label">Enter email address:</label>
                        <input type="email" class="form-control emailChartInput" placeholder="example@example.com" required>
                        <input type="hidden" class="chartTypeInput" value="nutrients">
                    </div>
                    <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Send Email</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
              </div>
            </div>
        </div>

        <div class="modal fade" id="allChartModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">Send all chart to email</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form class="emailChartForm">
                    <div class="modal-body">
                        <label class="form-label">Enter email address:</label>
                        <input type="email" class="form-control emailChartInput" placeholder="example@example.com" required>
                        <input type="hidden" class="chartTypeInput" value="all">
                    </div>
                    <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Send Email</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
              </div>
            </div>
        </div> 

    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        fetch('navbar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar').innerHTML = data;
            })
            .catch(error => console.error('Error loading navbar:', error));

        //Set date picker to current date
        const dateInput = document.getElementById("graphDataDate");
        dateInput.value = new Date().toISOString().split("T")[0];
        dateInput.max = new Date().toISOString().split("T")[0];

        const searchByDateButton = document.getElementById('searchByDateButton');
        let selectedDate = new Date(dateInput.value);
        let dateString = selectedDate.toISOString().split('T')[0];

        async function updateCharts(selectedDate) {
            const chartData = await fetchDataForChart(selectedDate);
            
            // Define chart IDs
            const charts = ["moistureChart", "temperatureChart", "pHChart", "conductivityChart", "nutrientsChart"];

            let hasData = false;
            
            for (const key in chartData) {
                if (chartData[key].length > 0) {
                    hasData = true;
                    break;
                }
            }

            charts.forEach(chartId => {
                const canvas = document.getElementById(chartId);
                const cardBody = canvas.closest(".card-body");
                const noDataMessage = cardBody.querySelector(".no-data-message");
                const hideButton = cardBody.querySelector(".hide-button");
                const hideDownloadAllButton = document.getElementById('downloadAllButton');
                const emailButton = cardBody.querySelector(".email-button");
                const emailAllButton = document.getElementById("emailAllButton");

                if (hasData) {
                    canvas.style.display = "block";
                    noDataMessage.style.display = "none";
                    hideButton.style.display = "block";
                    hideDownloadAllButton.style.display = "block";
                    emailButton.style.display = "block";
                    emailAllButton.style.display = "block";
                } else {
                    canvas.style.display = "none";
                    noDataMessage.style.display = "block";
                    hideButton.style.display = "none";
                    hideDownloadAllButton.style.display = "none";
                    emailButton.style.display = "none";
                    emailAllButton.style.display = "none";
                }
            });

            if (hasData) {
                createLineChart("moistureChart", "moisture", chartData);
                createLineChart("temperatureChart", "temperature", chartData);
                createLineChart("pHChart", "pH", chartData);
                createLineChart("conductivityChart", "conductivity", chartData);
                createBarChart("nutrientsChart", chartData);
            }
        }

        function downloadChart(canvasId, filename) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error("Canvas not found:", canvasId);
                return;
            }

            // Add white background
            const tempCanvas = document.createElement("canvas");
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const ctx = tempCanvas.getContext("2d");

            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            // Draw the chart on top of the white background
            ctx.drawImage(canvas, 0, 0);

            const imageURL = tempCanvas.toDataURL("image/png");

            const link = document.createElement("a");
            link.href = imageURL;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function downloadAllCharts() {
            const zip = new JSZip();
            const charts = ["moistureChart", "temperatureChart", "pHChart", "conductivityChart", "nutrientsChart"];

            for (const chartId of charts) {
                const canvas = document.getElementById(chartId);
                if (canvas) {
                    // Create a new canvas with a white background
                    const tempCanvas = document.createElement("canvas");
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    const ctx = tempCanvas.getContext("2d");

                    // Fill background with white
                    ctx.fillStyle = "white";
                    ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

                    // Draw the chart on top of the white background
                    ctx.drawImage(canvas, 0, 0);

                    // Convert to image and add to ZIP
                    const imageURL = tempCanvas.toDataURL("image/png");
                    const imageData = imageURL.split(",")[1];
                    zip.file(`${chartId}.png`, imageData, { base64: true });
                }
            }

            // Generate the ZIP file
            zip.generateAsync({ type: "blob" }).then(content => {
                const link = document.createElement("a");
                link.href = URL.createObjectURL(content);
                link.download = "Charts.zip";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        updateCharts(selectedDate);

        // Search button click handler
        searchByDateButton.addEventListener('click', async () => {
        selectedDate = new Date(dateInput.value);
        dateString = selectedDate.toISOString().split('T')[0];
        updateCharts(selectedDate);
        });
        
        document.querySelectorAll('.emailChartForm').forEach(form => {
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const userEmail = form.querySelector('.emailChartInput').value;
                const chartType = form.querySelector('.chartTypeInput').value;

                try {
                    if (chartType !== "all") {
                        let requestBody = { email: userEmail, date: dateString, chartType: chartType };
                        const response = await fetch("/sendChart", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(requestBody)
                        });
                        const result = await response.json();
                        alert(result.message);

                    }else{
                        let requestBody = { email: userEmail, date: dateString};
                        const response = await fetch("/sendAllCharts", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(requestBody)
                        });
                        const result = await response.json();
                        alert(result.message);
                    }
                } catch (error) {
                    console.error("Error sending chart email:", error);
                    alert("Failed to send email.");
                }
            });
        });

    </script>
  </body>
</html>